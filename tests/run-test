#!/bin/bash
set -o errexit -o nounset -o pipefail
function -h {
cat <<USAGE
 USAGE: run-test

  Push config and code for a test run to the target servers.

USAGE
}; function --help { -h ;}                 # A nice way to handle -h and --help

function main {
  [[ ${1:-} = --no-build ]] || build_and_bundle
  for num in {0..9}
  do init_host "$num"
  done

  # start up the test server on all but one of the hosts
  for num in {1..9}
  do start_testing_server "$num"
  done

  remote "00.netx-stats.emesos.co" --sudo -- run_testing_client "0"

  # shutdown all the test servers
  for num in {1..9}
  do stop_testing-server "$num"
  done
}

function build_and_bundle {
  sbt assembly
  sbt 'project service-net-tests' assembly
  mkdir -p tests/harness
  cp target/scala-*/service-net-assembly-*.jar tests/harness
  cp tests/target/scala-*/service-net-tests-assembly-*.jar tests/harness
}

function refresh {
  for host in 0{0..9}.netx-stats.emesos.co
  do remote "$host" --sudo -- reboot
  done
}

function globals {
  export LC_ALL=en_US.UTF-8                  # A locale that works consistently
  export LANG="$LC_ALL"
}; globals

function init_host {
  local num="$1"
  local hostname=0"$1".netx-stats.emesos.co

  # tar up the properties files for that host and copy it to the host
  ( cd tests/harness
    tar -cz *.jar H"$num"-NET1.properties net.json
  ) | ssh "$hostname" sudo tar -C /tmp -xz

  remote "$hostname" --sudo -- run_svcnet_over_configs "$num"
}

function run_svcnet_over_configs {(
  local num="$1"
  cd /tmp
  local config=H"$num"-NET1.properties
  local cmd=( java -Dsvcnet.config="$config" -jar service-net-assembly-*.jar )
  { printf ' :;' ; printf ' %q' "${cmd[@]}" ; echo ;} >&2
  "${cmd[@]}" &>/tmp/svcnet.log &
  local pid=$!
  ( sleep 10
    curl -X PUT http://localhost:9000/doc --data-binary @/tmp/net.json
  ) && local code=$? || local code=$?
  kill -TERM "$pid"
  [[ $code = 0 ]] || return $code
)}

function start_testing_server {
  local num="$1"
  local hostname=0"$1".netx-stats.emesos.co

  remote "$hostname" --sudo -- run_testing_server "$num"
}

function stop_testing_server {
  local num="$1"
  local hostname=0"$1".netx-stats.emesos.co

  remote "$hostname" --sudo -- kill -TERM $(cat /tmp/svcnet-test-server.pid) \
    && rm -f /tmp/svcnet-test-server.pid
}

function run_testing_server {(
  local num="$1"
  local hex_num=$( printf '%x' num)
  local addr="2001:db8:$hex_num:eeee::1"
  cd /tmp
  local cmd=( java -Dhttp.ip=$addr -jar service-net-tests-assembly-*.jar --server )
  { printf ' :;' ; printf ' %q' "${cmd[@]}" ; echo ;} >&2
  "${cmd[@]}" &>/tmp/svcnet-test-server.log &
  echo "$?" > svcnet-test-server.pid
)}

function run_testing_client {(
  local num="$1"
  local hex_num=$( printf '%x' num)
  local addr="2001:db8:$hex_num:eeee::0"
  cd /tmp
  local cmd=( java -jar service-net-tests-assembly-*.jar --client "$addr:9797" )
  { printf ' :;' ; printf ' %q' "${cmd[@]}" ; echo ;} >&2
  "${cmd[@]}" &>/tmp/svcnet-test-server.log && local code=$? || local code=$?
  [[ $code = 0 ]] || return $code
)}

##################################################################### Utilities

# Used like this: remote <ssh options> -- <command> <arg>*
function remote {
  local ssh=( -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no )
  local shell=( bash )
  while [[ ${1:+isset} ]]
  do
    case "$1" in
      --sudo) shell=( sudo bash ) ; shift ;;
      --)     shift ; break ;;
      *)      ssh=( "${ssh[@]}" "$1" ) ; shift ;;
    esac
  done
  serialized "$@" | ssh "${ssh[@]}" "${shell[@]}"
}

# Set up the actor on the remote end and then send it a message.
function serialized {
  declare -f
  echo set -o errexit -o nounset -o pipefail
  printf 'globals &&'
  printf ' %q' "$@" ; echo
}

function msg { out "$*" >&2 ;}
function err { local x=$? ; msg "$*" ; return $(( $x == 0 ? 1 : $x )) ;}
function out { printf '%s\n' "$*" ;}

# Handles "no-match" exit code specified by POSIX for filtering tools.
function maybe { "$@" || return $(( $? == 1 ? 0 : $? )) ;}

######################### Delegates to subcommands or runs main, as appropriate
if [[ ${1:-} ]] && declare -F | cut -d' ' -f3 | fgrep -qx -- "${1:-}"
then "$@"
else main "$@"
fi

